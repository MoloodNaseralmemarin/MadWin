@using Shop2City.WebHost.ViewModels.Factors
@model FactorSummaryViewModel

@{
    var factorId = Model.FactorSummary.FactorId;
    var totalPrice = Model.FactorSummary.FinalTotal;
}

<div class="container my-4">

    <!-- مسیر صفحه (Breadcrumb) -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-controller="Home" asp-action="Index">
                    <i class="fa fa-home"></i> خانه
                </a>
            </li>
            <li class="breadcrumb-item">
                <a asp-controller="Factors" asp-action="Index">
                    <i class="fa fa-file-invoice"></i> فاکتورها
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fa fa-shopping-cart"></i> سبد خرید
            </li>
        </ol>
    </nav>

    <!-- کارت سبد خرید -->
    <div class="card shadow border-0 rounded-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fa fa-shopping-basket"></i> خلاصه فاکتور</h5>
            <span class="badge bg-light text-dark">شماره فاکتور: @factorId</span>
        </div>

        <div class="card-body">
            @if (Model.FactorSummary.FactorDetails.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th><input type="checkbox" id="selectAll" /></th>
                                <th>محصول</th>
                                <th>قیمت واحد</th>
                                <th>تعداد</th>
                                <th>جمع جزء</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var detail in Model.FactorSummary.FactorDetails)
                            {
                                <tr>
                                    <td><input type="checkbox" class="delete-checkbox" value="@detail.Id" /></td>
                                    <td>@detail.ProductTitle</td>
                                    <td>@detail.Price.ToString("N0") تومان</td>
                                    <td>@detail.Quantity</td>
                                    <td>@detail.TotalPrice.ToString("N0") تومان</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="4" class="text-end fw-bold">مجموع کل:</td>
                                <td class="fw-bold text-success" id="SubtotalPrice">
                                    @totalPrice.ToString("N0") تومان
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-3 d-flex justify-content-between">
                    <button class="btn btn-danger" onclick="removeItems(@factorId)">
                        <i class="fa fa-trash"></i> حذف انتخاب‌شده‌ها
                    </button>
                    <a asp-action="Checkout" asp-route-factorId="@factorId" class="btn btn-success">
                        <i class="fa fa-credit-card"></i> ادامه خرید
                    </a>
                </div>
            }
            else
            {
                <div class="alert alert-warning text-center" role="alert">
                    <i class="fa fa-info-circle"></i> سبد خرید شما خالی است.
                </div>
            }
        </div>
    </div>
</div>

<!-- Toast -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    // تنظیمات پیش‌فرض toast
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "timeOut": "4000"
    };

    // حذف آیتم‌ها
    function removeItems(factorId) {
        var selectedIds = [];
        $(".delete-checkbox:checked").each(function () {
            selectedIds.push($(this).val());
        });

        if (selectedIds.length === 0) {
            toastr.warning('هیچ موردی انتخاب نشده است.');
            return;
        }

        $.ajax({
            url: '/Factors/RemoveItemsByFactor',
            type: 'POST',
            data: { factorDetailIds: selectedIds },
            traditional: true,
            success: function (response) {
                if (response.success) {
                    toastr.success("آیتم‌ها با موفقیت حذف شدند.");
                    location.reload();
                } else {
                    toastr.error("خطا در حذف آیتم‌ها.");
                }
            },
            error: function () {
                toastr.error("مشکلی در برقراری ارتباط با سرور رخ داد.");
            }
        });
    }

    // انتخاب همه چک‌باکس‌ها
    $("#selectAll").on("change", function () {
        $(".delete-checkbox").prop("checked", this.checked);
    });
</script>
